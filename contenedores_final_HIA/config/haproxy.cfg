global
    daemon
    maxconn 4096
    log stdout local0

defaults
    mode tcp
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    option tcplog
    log global

# Estadísticas de HAProxy
listen stats
    bind *:5000
    mode http
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE

# Pool de escritura (solo master)
listen postgres-write
    bind *:5432
    mode tcp
    option tcp-check
    tcp-check connect
    balance roundrobin
    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions
    server postgres-master postgres-master:5432 check

# Pool de lectura (replicas)
listen postgres-read
    bind *:5433
    mode tcp
    option tcp-check
    tcp-check connect
    balance roundrobin
    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions
    server postgres-replica1 postgres-replica1:5432 check
    server postgres-replica2 postgres-replica2:5432 check

# Pool mixto (master + replicas)
# Configurado para lectura/escritura con failover automático
# 
# Estrategia:
# - Todos los servidores están activos y disponibles
# - Health check TCP verifica que PostgreSQL esté disponible
# - El master tiene peso máximo (256) para recibir la mayoría de conexiones
# - Las réplicas tienen peso bajo (10) pero están disponibles para lectura
# - Balanceo 'source' mantiene consistencia de conexión por cliente (importante para transacciones)
# - En caso de failover: Patroni promueve una réplica a Leader automáticamente
#   Cuando esto ocurre, el nuevo Leader tendrá el mismo peso alto y recibirá las conexiones
# 
# Nota: PostgreSQL rechazará automáticamente las escrituras en réplicas (error esperado)
# Las lecturas funcionarán en todos los servidores
listen postgres-mixed
    bind *:5434
    mode tcp
    option tcp-check
    tcp-check connect
    # Balanceo por fuente IP: mantiene la misma conexión para el mismo cliente
    # Esto es importante para transacciones y sesiones
    balance source
    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions
    # Todos los servidores están activos
    # El master tiene peso 256 (máximo permitido, recibe ~96% de las conexiones)
    # Las réplicas tienen peso 10 (disponibles para lectura y failover)
    # En failover, cuando una réplica se promueve a master, mantendrá su configuración
    # y comenzará a recibir todas las conexiones debido al alto peso
    server postgres-master postgres-master:5432 check weight 256
    server postgres-replica1 postgres-replica1:5432 check weight 10
    server postgres-replica2 postgres-replica2:5432 check weight 10
