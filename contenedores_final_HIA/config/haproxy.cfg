global
    daemon
    maxconn 4096
    log stdout local0

defaults
    mode tcp
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    option tcplog
    log global

# Estadísticas de HAProxy
listen stats
    bind *:5000
    mode http
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE

# Pool mixto (lectura/escritura)
# Configuración con pesos hardcodeados
# IMPORTANTE: Si el líder cambia, actualizar los pesos manualmente y reiniciar HAProxy
# Peso alto (256) para el líder, peso bajo (1) para réplicas
listen postgres-mixed
    bind *:5434
    mode tcp
    balance source
    option tcp-check
    tcp-check connect
    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions
    # Líder actual: postgres-replica1 (peso 256)
    # Réplicas: peso 1
    # postgres-master está comentado porque está caído
    server postgres-master postgres-master:5432 check weight 256
    server postgres-replica1 postgres-replica1:5432 check weight 1
    server postgres-replica2 postgres-replica2:5432 check weight 1
